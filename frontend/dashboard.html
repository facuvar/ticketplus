<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Ticket+</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #121212;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #1e1e1e;
            border-right: 1px solid #333;
            flex-shrink: 0;
        }

        .logo {
            padding: 24px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #b0b0b0;
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #2a2a2a;
            color: #fff;
        }

        .nav-item.active {
            background: #2a2a2a;
            color: #4CAF50;
            border-left-color: #4CAF50;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main {
            flex: 1;
            background: #121212;
        }

        .header {
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Bot√≥n hamburguesa para m√≥viles */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .mobile-menu-btn:hover {
            background: #2a2a2a;
        }

        /* Overlay para cerrar men√∫ en m√≥vil */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .header-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #555;
            background: #2a2a2a;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #3a3a3a;
        }

        .btn-primary {
            background: #4CAF50;
            border-color: #4CAF50;
            color: white;
        }

        .content {
            padding: 32px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 14px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .stat-change.positive {
            color: #4CAF50;
        }

        .stat-change.negative {
            color: #f44336;
        }

        .view-report {
            margin-top: 16px;
        }

        .view-report a {
            color: #4CAF50;
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .chart-period {
            font-size: 14px;
            color: #b0b0b0;
        }

        .chart-placeholder {
            height: 200px;
            background: #2a2a2a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        /* Recent Activity */
        .activity-card {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .activity-list {
            space-y: 16px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .activity-content {
            flex: 1;
        }

        .activity-user {
            font-weight: 500;
            color: #fff;
        }

        .activity-action {
            font-size: 14px;
            color: #b0b0b0;
            margin-top: 2px;
        }

        .activity-time {
            font-size: 12px;
            color: #666;
        }

        .activity-amount {
            font-weight: 600;
            color: #4CAF50;
        }

        /* ===== NUEVOS ESTILOS PARA FUNCIONALIDADES ===== */

        /* Headers de secciones */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #333;
        }

        .section-header h2 {
            color: #fff;
            margin: 0;
            font-size: 24px;
        }

        .stats-summary {
            display: flex;
            gap: 12px;
        }

        .stat-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-badge.total { background: #1e88e5; color: white; }
        .stat-badge.pendiente { background: #ff9800; color: white; }
        .stat-badge.procesando { background: #2196f3; color: white; }
        .stat-badge.entregado { background: #4caf50; color: white; }
        .stat-badge.clickeadas { background: #4caf50; color: white; }
        .stat-badge.conversion { background: #9c27b0; color: white; }
        .stat-badge.activos { background: #4caf50; color: white; }

        /* Tablas de datos */
        .table-container {
            background: #1e1e1e;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            margin-bottom: 24px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #2a2a2a;
            color: #fff;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid #333;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid #333;
            color: #e0e0e0;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: #252525;
        }

        /* Badges de estado y tipo */
        .status-badge, .type-badge, .score-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pendiente { background: #ff9800; color: white; }
        .status-badge.procesando { background: #2196f3; color: white; }
        .status-badge.entregado { background: #4caf50; color: white; }
        .status-badge.activo { background: #4caf50; color: white; }
        .status-badge.inactivo { background: #f44336; color: white; }
        .status-badge.enviado { background: #4caf50; color: white; }

        .type-badge.normal { background: #666; color: white; }
        .type-badge.upsell { background: #4caf50; color: white; }
        .type-badge.complementario { background: #2196f3; color: white; }
        .type-badge.historico { background: #ff9800; color: white; }

        .score-badge {
            background: #4caf50;
            color: white;
        }

        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #666;
            font-size: 14px;
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .chart-simple {
            display: flex;
            gap: 16px;
            padding: 20px 0;
        }

        .chart-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .bar-label {
            font-size: 12px;
            color: #666;
        }

        .bar-container {
            height: 120px;
            display: flex;
            align-items: end;
        }

        .bar {
            width: 30px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-value {
            font-size: 12px;
            color: #4caf50;
            font-weight: 600;
        }

        .top-productos {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .producto-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .ranking {
            font-weight: 700;
            color: #4caf50;
            min-width: 30px;
        }

        .nombre {
            flex: 1;
            color: #fff;
        }

        .stats {
            font-size: 12px;
            color: #666;
        }

        /* Configuraci√≥n */
        .config-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .config-card {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
        }

        .config-card h3 {
            color: #fff;
            margin-bottom: 16px;
            font-size: 18px;
        }

        .config-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-field label {
            color: #b0b0b0;
            font-size: 14px;
            font-weight: 500;
        }

        .form-field input {
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #2a2a2a;
            color: #e0e0e0;
            font-size: 14px;
        }

        .form-field input:focus {
            outline: none;
            border-color: #4caf50;
        }

        .config-actions {
            display: flex;
            justify-content: center;
        }

        /* Mensajes de error */
        .error-message {
            text-align: center;
            padding: 40px;
            color: #f44336;
            font-size: 18px;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 12px;
        }

        /* RESPONSIVE DESIGN PARA M√ìVILES */
        @media (max-width: 768px) {
            .app {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -260px;
                width: 260px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                background: #1e1e1e;
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main {
                width: 100%;
                margin-left: 0;
            }

            .header {
                padding: 12px 16px;
                position: relative;
            }

            .mobile-menu-btn {
                display: block;
                margin-right: 12px;
            }

            .header-title {
                font-size: 20px;
            }

            .header-controls {
                gap: 8px;
            }

            .header-controls .btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 24px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .chart-card {
                padding: 16px;
            }

            .activity-card {
                padding: 16px;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .config-sections {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .config-card {
                padding: 16px;
            }

            .table-container {
                overflow-x: auto;
            }

            .data-table {
                min-width: 600px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .section-header h2 {
                font-size: 20px;
            }

            .stats-summary {
                flex-wrap: wrap;
                gap: 8px;
            }

            .stat-badge {
                font-size: 12px;
                padding: 4px 8px;
            }
        }

        /* Para tablets peque√±as */
        @media (max-width: 480px) {
            .header-controls {
                display: none;
            }

            .header-title {
                font-size: 18px;
            }

            .stats-grid {
                gap: 12px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .chart-card, .activity-card {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Overlay para cerrar men√∫ en m√≥vil -->
        <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">T+</div>
                <div class="logo-text">Ticket+</div>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item active">
                    <div class="nav-icon">üìä</div>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item">
                    <div class="nav-icon">üì¶</div>
                    <span>Pedidos</span>
                </div>
                <div class="nav-item">
                    <div class="nav-icon">üéØ</div>
                    <span>Recomendaciones</span>
                </div>
                <div class="nav-item">
                    <div class="nav-icon">üì±</div>
                    <span>WhatsApp</span>
                </div>
                <div class="nav-item">
                    <div class="nav-icon">üë•</div>
                    <span>Clientes</span>
                </div>
                <div class="nav-item">
                    <div class="nav-icon">üìà</div>
                    <span>Analytics</span>
                </div>
                <div class="nav-item">
                    <div class="nav-icon">‚öôÔ∏è</div>
                    <span>Configuraci√≥n</span>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main">
            <header class="header">
                <div style="display: flex; align-items: center;">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
                    <h1 class="header-title" style="cursor: pointer;" onclick="mostrarDashboard()">üìä Dashboard</h1>
                </div>
                <div class="header-controls">
                    <button class="btn">Filtrar Por</button>
                    <button class="btn btn-primary">Exportar</button>
                    <div style="color: #666;">Marzo</div>
                </div>
            </header>

            <main class="content">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">üìã Pedidos Hoy</div>
                        </div>
                        <div class="stat-value" id="pedidos-hoy">--</div>
                        <div class="stat-change positive">‚Üó 4.2%</div>
                        <div class="view-report">
                            <a href="#">Ver Reporte ‚Üí</a>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">üéØ Recomendaciones Enviadas</div>
                        </div>
                        <div class="stat-value" id="recomendaciones-enviadas">--</div>
                        <div class="stat-change positive">‚Üó 20% vs mes anterior</div>
                        <div class="view-report">
                            <a href="#">Ver Reporte ‚Üí</a>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">üìà Conversi√≥n %</div>
                        </div>
                        <div class="stat-value" id="conversion-rate">--%</div>
                        <div class="stat-change negative">‚Üì 1%</div>
                        <div class="view-report">
                            <a href="#">Ver Reporte ‚Üí</a>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">üí∞ Ingresos x Ticket+</div>
                        </div>
                        <div class="stat-value" id="ingresos-ticket-plus">$--</div>
                        <div class="stat-change positive">‚Üó Ventas adicionales</div>
                        <div class="view-report">
                            <a href="#">Ver Reporte ‚Üí</a>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Ingresos x Ticket+ (7 d√≠as)</h3>
                            <div class="chart-period">√öltimos 7 d√≠as</div>
                        </div>
                        <div class="chart-placeholder" id="chart-ingresos">
                            üìä Cargando gr√°fico de ingresos...
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Canales de Tr√°fico</h3>
                            <div class="chart-period">Todo el tiempo</div>
                        </div>
                        <div class="chart-placeholder">
                            ü•ß Gr√°fico Circular<br>
                            Directo: 50.5%<br>
                            Referido: 30.5%<br>
                            Org√°nico: 19%
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="activity-card">
                    <div class="activity-header">
                        <h3 class="chart-title">√öltimos Pedidos con Recomendaciones</h3>
                    </div>
                    <div id="pedidos-recientes-container">
                        <!-- La tabla de pedidos se insertar√° aqu√≠ -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Estado global de la aplicaci√≥n
        const app = {
            mayorista_id: 4,
            seccion_actual: 'dashboard'
        };

        // Cargar datos del dashboard
        async function cargarDashboard() {
            try {
                // Esperar un poco para asegurar que el DOM est√© listo
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Verificar que los elementos del dashboard existen
                const elementosPedidosHoy = document.getElementById('pedidos-hoy');
                
                if (!elementosPedidosHoy) {
                    console.log('Elementos del dashboard no encontrados, no estamos en la vista del dashboard');
                    return; // No estamos en la vista del dashboard
                }
                
                const response = await fetch(`/api/v1/admin/dashboard/4`); // Usar ID fijo por ahora
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Datos del dashboard cargados:', data);
                
                // Funci√≥n helper para actualizar elementos de forma segura
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                        return true;
                    }
                    return false;
                };
                
                // Actualizar m√©tricas principales
                updateElement('pedidos-hoy', data.pedidos_hoy || 0);
                updateElement('recomendaciones-enviadas', data.recomendaciones_enviadas || 0);
                updateElement('conversion-rate', (data.conversion_rate || 0) + '%');
                
                // NUEVA M√âTRICA: Ingresos x Ticket+
                const ingresos = data.ingresos_ticket_plus || 0;
                updateElement('ingresos-ticket-plus', '$' + new Intl.NumberFormat('es-AR').format(ingresos));
                
                // Actualizar ticket promedio si existe
                const ticketPromedio = data.ticket_promedio || 0;
                updateElement('ticket-promedio', '$' + new Intl.NumberFormat('es-AR').format(ticketPromedio));
                
                // Actualizar gr√°fico de pedidos (primer canvas)
                try {
                    const pedidosChart = document.getElementById('pedidosChart');
                    if (pedidosChart && data.graficos && data.graficos.pedidos_por_dia) {
                        const container = pedidosChart.parentElement;
                        const totalPedidos = data.graficos.pedidos_por_dia.reduce((sum, p) => sum + p, 0);
                        container.innerHTML = `
                            <h3>üìà Pedidos √öltimos 7 D√≠as</h3>
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 32px; margin-bottom: 10px; color: #2196F3;">
                                    üì¶ ${totalPedidos}
                                </div>
                                <div style="color: #2196F3; margin-bottom: 15px; font-size: 16px;">
                                    Total pedidos (7 d√≠as)
                                </div>
                                <div style="color: #b0b0b0; font-size: 14px;">
                                    Promedio diario: ${(totalPedidos / 7).toFixed(1)} pedidos
                                </div>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.warn('Error actualizando gr√°fico pedidos:', e);
                }
                
                // Actualizar gr√°fico de ingresos
                try {
                    if (typeof actualizarGraficoIngresos === 'function' && data.graficos) {
                        actualizarGraficoIngresos(data.graficos);
                    }
                } catch (e) {
                    console.warn('Error actualizando gr√°fico ingresos:', e);
                }
                
                // Actualizar productos m√°s recomendados
                try {
                    if (typeof actualizarProductosRecomendados === 'function' && data.productos_mas_recomendados) {
                        actualizarProductosRecomendados(data.productos_mas_recomendados);
                    }
                } catch (e) {
                    console.warn('Error actualizando productos:', e);
                }
                
                // LLAMAR A CARGAR PEDIDOS AL FINAL
                await cargarPedidos();
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                
                // Funci√≥n helper para actualizar elementos de forma segura en caso de error
                const updateElementSafe = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };
                
                // Mostrar valores por defecto en caso de error
                updateElementSafe('pedidos-hoy', 'Error');
                updateElementSafe('recomendaciones-enviadas', 'Error');
                updateElementSafe('conversion-rate', 'Error');
                updateElementSafe('ingresos-ticket-plus', 'Error');
            }
        }

        // üì¶ CARGAR PEDIDOS
        async function cargarPedidos() {
            try {
                const response = await fetch(`/api/v1/admin/pedidos/${app.mayorista_id}?limit=5`); // Limitar a 5 para el dashboard
                const data = await response.json();
                
                // Seleccionar el nuevo contenedor en el dashboard
                const container = document.getElementById('pedidos-recientes-container');
                
                // Si estamos en la secci√≥n de pedidos, usar el contenedor principal
                const content = document.querySelector('.content');
                const targetContainer = app.seccion_actual === 'pedidos' ? content : container;

                if (!targetContainer) {
                    console.log("No se encontr√≥ el contenedor de destino para los pedidos.");
                    return;
                }

                const tablaHTML = `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pedido</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.pedidos.map(pedido => `
                                    <tr>
                                        <td><strong>${pedido.numero_pedido}</strong></td>
                                        <td>${pedido.cliente.nombre}</td>
                                        <td><span class="type-badge ${pedido.tipo.toLowerCase()}">${pedido.tipo}</span></td>
                                        <td><span class="status-badge ${pedido.estado}">${pedido.estado}</span></td>
                                        <td>$${new Intl.NumberFormat('es-AR').format(pedido.total)}</td>
                                        <td>
                                            <a href="/api/v1/carrito/${pedido.token_carrito}" target="_blank" class="btn-primary" style="text-decoration: none; padding: 6px 12px; font-size: 12px; border-radius: 6px;">Ver Carrito</a>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                if (app.seccion_actual === 'pedidos') {
                    // Reemplazar todo el contenido si estamos en la secci√≥n de Pedidos
                    targetContainer.innerHTML = `
                        <div class="section-header">
                            <h2>üì¶ Gesti√≥n de Pedidos</h2>
                    </div>
                        ${tablaHTML}
                `;
                } else {
                    // Solo a√±adir la tabla si estamos en el Dashboard
                    targetContainer.innerHTML = tablaHTML;
                }
                
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                const container = document.getElementById('pedidos-recientes-container');
                if (container) {
                    container.innerHTML = '<p class="error-message">No se pudieron cargar los pedidos.</p>';
                }
            }
        }

        // üéØ CARGAR RECOMENDACIONES
        async function cargarRecomendaciones() {
            try {
                const response = await fetch(`/api/v1/admin/recomendaciones/${app.mayorista_id}?limit=20`);
                const data = await response.json();
                
                const content = document.querySelector('.content');
                content.innerHTML = `
                    <div class="section-header">
                        <h2>üéØ Recomendaciones Generadas</h2>
                        <div class="stats-summary">
                            <span class="stat-badge total">Total: ${data.total}</span>
                            <span class="stat-badge clickeadas">Clickeadas: ${data.clickeadas}</span>
                            <span class="stat-badge conversion">Conversi√≥n: ${data.conversion_rate}%</span>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cliente</th>
                                    <th>Precio</th>
                                    <th>Tipo</th>
                                    <th>Score</th>
                                    <th>Estado</th>
                                    <th>Click</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.recomendaciones.map(rec => `
                                    <tr>
                                        <td><strong>${rec.producto_nombre}</strong></td>
                                        <td>${rec.pedido.cliente}</td>
                                        <td>$${new Intl.NumberFormat('es-AR').format(rec.precio)}</td>
                                        <td><span class="type-badge ${rec.tipo.toLowerCase()}">${rec.tipo}</span></td>
                                        <td><span class="score-badge">${rec.score}</span></td>
                                        <td><span class="status-badge ${rec.estado}">${rec.estado}</span></td>
                                        <td>${rec.fue_clickeada ? '‚úÖ S√≠' : '‚ùå No'}</td>
                                        <td>${new Date(rec.fecha_generacion).toLocaleDateString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando recomendaciones:', error);
                mostrarError('Error cargando recomendaciones');
            }
        }

        // üì± CARGAR WHATSAPP
        async function cargarWhatsapp() {
            try {
                const response = await fetch(`/api/v1/admin/whatsapp/${app.mayorista_id}`);
                const data = await response.json();
                
                const content = document.querySelector('.content');
                content.innerHTML = `
                    <div class="section-header">
                        <h2>üì± Estad√≠sticas WhatsApp</h2>
                        <div class="stats-summary">
                            <span class="stat-badge total">Mensajes: ${data.mensajes_enviados}</span>
                            <span class="stat-badge clickeadas">Clicks: ${data.clicks_whatsapp}</span>
                            <span class="stat-badge conversion">Apertura: ${data.tasa_apertura}%</span>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pedido</th>
                                    <th>Cliente</th>
                                    <th>Tel√©fono</th>
                                    <th>Enviado</th>
                                    <th>Click</th>
                                    <th>Fecha Click</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.ultimos_mensajes.map(msg => `
                                    <tr>
                                        <td><strong>${msg.pedido_numero}</strong></td>
                                        <td>${msg.cliente}</td>
                                        <td>${msg.telefono || 'No disponible'}</td>
                                        <td>${msg.fecha_envio ? new Date(msg.fecha_envio).toLocaleDateString() : 'No enviado'}</td>
                                        <td>${msg.click_realizado ? '‚úÖ S√≠' : '‚ùå No'}</td>
                                        <td>${msg.fecha_click ? new Date(msg.fecha_click).toLocaleDateString() : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando WhatsApp:', error);
                mostrarError('Error cargando estad√≠sticas WhatsApp');
            }
        }

        // üë• CARGAR CLIENTES
        async function cargarClientes() {
            try {
                const response = await fetch(`/api/v1/admin/clientes/${app.mayorista_id}?limit=20`);
                const data = await response.json();
                
                const content = document.querySelector('.content');
                content.innerHTML = `
                    <div class="section-header">
                        <h2>üë• Gesti√≥n de Clientes</h2>
                        <div class="stats-summary">
                            <span class="stat-badge total">Total: ${data.total}</span>
                            <span class="stat-badge activos">Activos: ${data.activos}</span>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Email</th>
                                    <th>WhatsApp</th>
                                    <th>Pedidos</th>
                                    <th>Ticket Promedio</th>
                                    <th>√öltimo Pedido</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.clientes.map(cliente => `
                                    <tr>
                                        <td><strong>${cliente.nombre}</strong></td>
                                        <td>${cliente.email || 'No disponible'}</td>
                                        <td>${cliente.whatsapp_numero || 'No disponible'}</td>
                                        <td>${cliente.total_pedidos}</td>
                                        <td>$${new Intl.NumberFormat('es-AR').format(cliente.ticket_promedio)}</td>
                                        <td>${cliente.fecha_ultimo_pedido ? new Date(cliente.fecha_ultimo_pedido).toLocaleDateString() : 'Nunca'}</td>
                                        <td><span class="status-badge ${cliente.activo ? 'activo' : 'inactivo'}">${cliente.activo ? 'Activo' : 'Inactivo'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando clientes:', error);
                mostrarError('Error cargando clientes');
            }
        }

        // üìà CARGAR ANALYTICS
        async function cargarAnalytics() {
            try {
                const response = await fetch(`/api/v1/admin/analytics/${app.mayorista_id}?dias=7`);
                const data = await response.json();
                
                const content = document.querySelector('.content');
                content.innerHTML = `
                    <div class="section-header">
                        <h2>üìà Analytics Avanzado</h2>
                        <div class="stats-summary">
                            <span class="stat-badge total">Recomendaciones: ${data.resumen.total_recomendaciones}</span>
                            <span class="stat-badge clickeadas">Clicks: ${data.resumen.total_clicks}</span>
                            <span class="stat-badge conversion">Conversi√≥n: ${data.resumen.conversion_promedio}%</span>
                        </div>
                    </div>

                    <div class="analytics-grid">
                        <div class="chart-card">
                            <h3>üìä Conversi√≥n por D√≠a (7 d√≠as)</h3>
                            <div class="chart-simple">
                                ${data.conversion_por_dia.map(dia => `
                                    <div class="chart-bar">
                                        <div class="bar-label">${dia.fecha}</div>
                                        <div class="bar-container">
                                            <div class="bar" style="height: ${Math.max(dia.conversion * 2, 10)}px; background: #4CAF50;"></div>
                                        </div>
                                        <div class="bar-value">${dia.conversion}%</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="chart-card">
                            <h3>üèÜ Top Productos Recomendados</h3>
                            <div class="top-productos">
                                ${data.top_productos.slice(0, 5).map((producto, index) => `
                                    <div class="producto-item">
                                        <span class="ranking">#${index + 1}</span>
                                        <span class="nombre">${producto.nombre}</span>
                                        <span class="stats">${producto.recomendaciones} recs, ${producto.conversion}% conv</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando analytics:', error);
                mostrarError('Error cargando analytics');
            }
        }

        // ‚öôÔ∏è CARGAR CONFIGURACI√ìN
        async function cargarConfiguracion() {
            try {
                const response = await fetch(`/api/v1/admin/configuracion/${app.mayorista_id}`);
                const data = await response.json();
                
                const content = document.querySelector('.content');
                content.innerHTML = `
                    <div class="section-header">
                        <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                    </div>

                    <div class="config-sections">
                        <div class="config-card">
                            <h3>üè¢ Informaci√≥n del Mayorista</h3>
                            <div class="config-form">
                                <div class="form-field">
                                    <label>Nombre:</label>
                                    <input type="text" value="${data.mayorista.nombre}" readonly>
                                </div>
                                <div class="form-field">
                                    <label>Email:</label>
                                    <input type="email" value="${data.mayorista.email || ''}" readonly>
                                </div>
                                <div class="form-field">
                                    <label>Tel√©fono:</label>
                                    <input type="tel" value="${data.mayorista.telefono || ''}" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="config-card">
                            <h3>üéØ Configuraci√≥n de Recomendaciones</h3>
                            <div class="config-form">
                                <div class="form-field">
                                    <label>Recomendaciones Activas:</label>
                                    <input type="checkbox" ${data.mayorista.recomendaciones_activas ? 'checked' : ''} disabled>
                                </div>
                                <div class="form-field">
                                    <label>Tiempo de Espera (horas):</label>
                                    <input type="number" value="${data.mayorista.tiempo_espera_horas || 24}" readonly>
                                </div>
                                <div class="form-field">
                                    <label>M√°x. Productos Recomendados:</label>
                                    <input type="number" value="${data.mayorista.max_productos_recomendados || 6}" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="config-card">
                            <h3>üì± Configuraci√≥n WhatsApp</h3>
                            <div class="config-form">
                                <div class="form-field">
                                    <label>API Key:</label>
                                    <input type="password" value="${data.whatsapp.api_key || ''}" readonly>
                                </div>
                                <div class="form-field">
                                    <label>N√∫mero de Tel√©fono:</label>
                                    <input type="tel" value="${data.whatsapp.phone_number || ''}" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="config-card">
                            <h3>üóÑÔ∏è Conexi√≥n Gescom</h3>
                            <div class="config-form">
                                <div class="form-field">
                                    <label>Host:</label>
                                    <input type="text" value="${data.gescom.host || ''}" readonly>
                                </div>
                                <div class="form-field">
                                    <label>Base de Datos:</label>
                                    <input type="text" value="${data.gescom.base_datos || ''}" readonly>
                                </div>
                                <div class="form-field">
                                    <label>Usuario:</label>
                                    <input type="text" value="${data.gescom.usuario || ''}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="config-actions">
                        <button class="btn btn-primary" onclick="alert('Funcionalidad de edici√≥n pr√≥ximamente')">
                            ‚úèÔ∏è Editar Configuraci√≥n
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
                mostrarError('Error cargando configuraci√≥n');
            }
        }

        function mostrarError(mensaje) {
            const content = document.querySelector('.content');
            content.innerHTML = `
                <div class="error-message">
                    ‚ùå ${mensaje}
                </div>
            `;
        }
        
        // Actualizar gr√°fico de ingresos (versi√≥n simplificada)
        function actualizarGraficoIngresos(graficos) {
            // Buscar el canvas de ingresos
            const chartElement = document.getElementById('ingresosChart');
            
            if (!chartElement) {
                console.log('Canvas de ingresos no encontrado');
                return;
            }
            
            if (!graficos || !graficos.fechas || !graficos.ingresos_por_dia) {
                // Crear un div para mostrar mensaje de sin datos
                const container = chartElement.parentElement;
                container.innerHTML = '<h3>üí∞ Ingresos por Ticket+ (7 d√≠as)</h3><div style="text-align: center; padding: 40px; color: #888;">üìä Sin datos de ingresos</div>';
                return;
            }
            
            const totalIngresos = graficos.ingresos_por_dia.reduce((sum, ing) => sum + ing, 0);
            const promedioDiario = totalIngresos / graficos.fechas.length;
            
            // Reemplazar el canvas con informaci√≥n est√°tica por ahora
            const container = chartElement.parentElement;
            container.innerHTML = `
                <h3>üí∞ Ingresos por Ticket+ (7 d√≠as)</h3>
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 32px; margin-bottom: 10px; color: #4CAF50;">
                        üìà $${new Intl.NumberFormat('es-AR').format(totalIngresos)}
                    </div>
                    <div style="color: #4CAF50; margin-bottom: 15px; font-size: 16px;">
                        Total √∫ltimos 7 d√≠as
                    </div>
                    <div style="color: #b0b0b0; font-size: 14px; margin-bottom: 10px;">
                        Promedio diario: $${new Intl.NumberFormat('es-AR').format(promedioDiario)}
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #888;">
                        üìÖ ${graficos.fechas.slice(-3).join(' ‚Ä¢ ')}
                    </div>
                </div>
            `;
        }
        
        // Actualizar productos m√°s recomendados
        function actualizarProductosRecomendados(productos) {
            const productosContainer = document.getElementById('productos-recomendados');
            
            if (!productosContainer) {
                console.log('Contenedor de productos recomendados no encontrado');
                return;
            }
            
            if (!productos || productos.length === 0) {
                productosContainer.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-details">
                            <div class="activity-title">No hay productos recomendados disponibles</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            productos.slice(0, 5).forEach((producto, index) => {
                const percentage = productos.length > 0 ? ((producto.veces / productos[0].veces) * 100).toFixed(1) : 0;
                html += `
                    <div class="activity-item">
                        <div class="activity-avatar">#${index + 1}</div>
                        <div class="activity-details">
                            <div class="activity-title">${producto.nombre}</div>
                            <div class="activity-description">Recomendado ${producto.veces} veces</div>
                        </div>
                        <div class="activity-time">${percentage}%</div>
                    </div>
                `;
            });
            
            productosContainer.innerHTML = html;
        }

        // Navegaci√≥n del sidebar
        // Navegaci√≥n con funcionalidad real
        document.querySelectorAll('.nav-item').forEach((item, index) => {
            item.addEventListener('click', () => {
                // Actualizar navegaci√≥n visual
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // Actualizar t√≠tulo del header
                const headerTitle = document.querySelector('.header-title');
                
                // Si estamos en m√≥vil, cerrar el men√∫ despu√©s de hacer clic
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        const sidebar = document.getElementById('sidebar');
                        const overlay = document.querySelector('.sidebar-overlay');
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('active');
                    }, 150); // Peque√±o delay para que se vea la selecci√≥n
                }
                
                // Llamar funci√≥n correspondiente seg√∫n el √≠ndice
                switch(index) {
                    case 0: // Dashboard
                        app.seccion_actual = 'dashboard';
                        headerTitle.textContent = 'üìä Dashboard';
                        mostrarDashboard();
                        break;
                    case 1: // Pedidos
                        app.seccion_actual = 'pedidos';
                        headerTitle.textContent = 'Gesti√≥n de Pedidos';
                        cargarPedidos();
                        break;
                    case 2: // Recomendaciones
                        app.seccion_actual = 'recomendaciones';
                        headerTitle.textContent = 'Recomendaciones';
                        cargarRecomendaciones();
                        break;
                    case 3: // WhatsApp
                        app.seccion_actual = 'whatsapp';
                        headerTitle.textContent = 'Estad√≠sticas WhatsApp';
                        cargarWhatsapp();
                        break;
                    case 4: // Clientes
                        app.seccion_actual = 'clientes';
                        headerTitle.textContent = 'Gesti√≥n de Clientes';
                        cargarClientes();
                        break;
                    case 5: // Analytics
                        app.seccion_actual = 'analytics';
                        headerTitle.textContent = 'Analytics Avanzado';
                        cargarAnalytics();
                        break;
                    case 6: // Configuraci√≥n
                        app.seccion_actual = 'configuracion';
                        headerTitle.textContent = 'Configuraci√≥n';
                        cargarConfiguracion();
                        break;
                }
            });
        });

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            // Esperar un poco m√°s antes de cargar
            setTimeout(() => {
                cargarDashboard();
            }, 500);
            
            // Actualizar cada 60 segundos (reducido para testing)
            setInterval(cargarDashboard, 60000);
        });
        // Funci√≥n para volver al dashboard principal
        function mostrarDashboard() {
            try {
                // Actualizar navegaci√≥n visual - activar primera opci√≥n (Dashboard)
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                
                // Actualizar t√≠tulo
                document.querySelector('.header-title').innerHTML = 'üìä Dashboard';
                
                // Restaurar estructura HTML original del dashboard
                document.querySelector('.content').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-value" id="pedidos-hoy">--</div>
                                <div class="stat-label">Pedidos Hoy</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üéØ</div>
                            <div class="stat-content">
                                <div class="stat-value" id="recomendaciones-enviadas">--</div>
                                <div class="stat-label">Recomendaciones Enviadas</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-content">
                                <div class="stat-value" id="conversion-rate">--%</div>
                                <div class="stat-label">Conversi√≥n</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üíµ</div>
                            <div class="stat-content">
                                <div class="stat-value" id="ticket-promedio">$--</div>
                                <div class="stat-label">Ticket Promedio</div>
                            </div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-content">
                                <div class="stat-value" id="ingresos-ticket-plus">$--</div>
                                <div class="stat-label">Ingresos x Ticket+ (7 d√≠as)</div>
                            </div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>üìà Pedidos √öltimos 7 D√≠as</h3>
                            <canvas id="pedidosChart" width="400" height="200"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>üí∞ Ingresos por Ticket+ (7 d√≠as)</h3>
                            <canvas id="ingresosChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <div class="activity-section">
                        <h3>üî• Productos M√°s Recomendados</h3>
                        <div class="activity-list" id="productos-recomendados">
                            <div class="activity-item">
                                <div class="activity-details">
                                    <div class="activity-title">Cargando productos...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // IMPORTANTE: Recargar todos los datos del dashboard
                setTimeout(() => {
                    cargarDashboard();
                }, 200);
                
            } catch (error) {
                console.error('Error en mostrarDashboard():', error);
                alert('Error: ' + error.message);
            }
        }

        // ===== FUNCIONES PARA MEN√ö M√ìVIL =====
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar.classList.contains('mobile-open')) {
                // Cerrar men√∫
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            } else {
                // Abrir men√∫
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            }
        }



        // Cerrar men√∫ al cambiar el tama√±o de ventana (si se pasa a desktop)
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            }
        });

    </script>
</body>
</html> 